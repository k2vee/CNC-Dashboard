{% extends 'base.html' %}
{% block content %}
<div id="motorSelectionButtons">
    <button id="buttonX" class="motor-button selected-button">
        Motor X</button>
    <button id="buttonY" class="motor-button selected-button">
        Motor Y</button>
    <button id="buttonZ" class="motor-button selected-button">
        Motor Z</button>
    <button id="buttonSpindle" class="motor-button selected-button">
        Spindle</button>
</div>
<div id="latestValues">
    <div class="chart-latestValues">
        <p class="valueTitle">Servo Cycle Count</p>
        <p class="motorId">Motor X</p>
        <p id="latest-X-chart1">0</p>
        <p class="motorId">Motor Y</p>
        <p id="latest-Y-chart1">0</p>
        <p class="motorId">Motor Z</p>
        <p id="latest-Z-chart1">0</p>
    </div>
    <div class="chart-latestValues">
        <p class="valueTitle">Spindle Cycle Count</p>
        <p class="motorId">Spindle</p>
        <p id="latest-Spindle-chart2">0</p>
    </div>
</div>
<div id="cycleCountsGraphs" class="graph-container">
    <div class="chart-wrapper">
        <canvas id="cycleCountsChart"></canvas>
    </div>
    <div class="chart-wrapper">
        <canvas id="cycleCountsSpindleChart"></canvas>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    // Global vars/accessible data objects
    var CYCCNTData, CycleCountData;
    var timerId;
    const cycleCountsCanvasId = 'cycleCountsChart';
    const cycleCountsSpindleCanvasId = 'cycleCountsSpindleChart';

    // Event listeners
    document.getElementById("buttonX").addEventListener("click", () => onFilterButtonClick('X'));
    document.getElementById("buttonY").addEventListener("click", () => onFilterButtonClick('Y'));
    document.getElementById("buttonZ").addEventListener("click", () => onFilterButtonClick('Z'));
    document.getElementById("buttonSpindle").addEventListener("click", () => onFilterButtonClick('Spindle'));
    document.addEventListener('DOMContentLoaded', async () => {
        CYCCNTData = await fetchDataGroupLimited('CYCCNT', 51);
        CYCCNTData.reverse();
        createCYCCNTCharts(CYCCNTData);
        CycleCountData = await fetchDataGroupLimited('CycleCount', 51);
        CycleCountData.reverse();
        createCycleCountCharts(CycleCountData);
        timerId = setInterval(pollServer, 1000);
    });

    // Function to update the 'CYCCNT' line chart
    function createCYCCNTCharts(data) {
        const cyccntLabels = Array.from({ length: 51 }, (_, i) => i); // Sequential x-axis values
        const cyccntDatasets = createDatasets(CYCCNTData, ['X', 'Y', 'Z']);
        // Create line chart with datasets for 'CYCCNT'
        createLineChart(cycleCountsCanvasId, cyccntLabels, cyccntDatasets, 'CYCCNT');
    }

    // Function to update the 'SpindleCount' line chart
    function createCycleCountCharts(data) {
        const cycleCountlabels = Array.from({ length: 51 }, (_, i) => i); // Sequential x-axis values
        const cycleCountDatasets = createDatasets(CycleCountData, ['Spindle']);
        // Create line chart with datasets for 'CycleCount'
        createLineChart(cycleCountsSpindleCanvasId, cycleCountlabels, cycleCountDatasets, 'CycleCount');
    }

    function onFilterButtonClick(motor) {
        const button = document.getElementById(`button${motor}`);
        button.classList.toggle("selected-button");
        datasetFilter(cycleCountsCanvasId, motor);
        datasetFilter(cycleCountsSpindleCanvasId, motor);
    }

    async function pollServer() {
        const alphabetArray = ['X', 'Y', 'Z', 'Spindle'];
        for(var i = 0; i < 3; i++)  {
            const latestRecord = await fetchDataSingular(`CYCCNT${i+1}`);
            CYCCNTData.shift();
            CYCCNTData.push(latestRecord);
            shiftLineChartData(cycleCountsCanvasId, `${alphabetArray[i]}`, latestRecord);
            document.getElementById(`latest-${alphabetArray[i]}-chart1`).innerHTML = latestRecord[0].Value;
        }
        for(var i = 0; i < 1; i++)  {
            const latestRecord = await fetchDataSingular(`CycleCount${i+1}`);
            CycleCountData.shift();
            CycleCountData.push(latestRecord);
            shiftLineChartData(cycleCountsSpindleCanvasId, `${alphabetArray[3]}`, latestRecord);
            document.getElementById(`latest-${alphabetArray[3]}-chart2`).innerHTML = latestRecord[0].Value;
        }
    }
</script>
{% endblock%}