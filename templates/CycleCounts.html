{% extends 'base.html' %}
{% block content %}
    <div id="motorSelectionButtons">
        <button id="buttonX" class="motor-button selected-button" onclick="aeiou('X')">
            Motor X</button>
        <button id="buttonY" class="motor-button selected-button" onclick="aeiou('Y')">
            Motor Y</button>
        <button id="buttonZ" class="motor-button selected-button" onclick="aeiou('Z')">
            Motor Z</button>
        <button id="buttonSpindle" class="motor-button selected-button" onclick="aeiou('Spindle')">
            Spindle</button>
    </div>
    <div id="latestValues">
        <h2>Motor Currents</h2>
        <h3>Motor X</h3>
        <p id="latest-X">0</p>
        <h3>Motor Y</h3>
        <p id="latest-Y">0</p>
        <h3>Motor Z</h3>
        <p id="latest-Z">0</p>
        <h3>Cycle Count Spindle</h3>
        <p class="latest-Spindle">0</p>
    </div>
    <div id="cycleCountsGraphs" class="graph-container">
        <div class="chart-wrapper">
            <canvas id="cycleCountsChart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="cycleCountsSpindleChart"></canvas>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        // Global vars/accessible data objects
        var CYCCNTData, CycleCountData;
        const cycleCountsChartId = 'cycleCountsChart';
        const cycleCountsSpindleChartId = 'cycleCountsSpindleChart';

        document.addEventListener('DOMContentLoaded', async function()    {
            /*
            // Ideally, the data is already filtered server-side so the entire database isnt passed to client,
            // then the client has to filter it.
            */
            CYCCNTData = await fetchDataGroup('CYCCNT');
            CYCCNTData.reverse();
            filterUpdateCYCCNTCharts(CYCCNTData);

            CycleCountData = await fetchDataGroup('CycleCount');
            CycleCountData.reverse();
            filterUpdateCycleCountCharts(CycleCountData);
            
            updateCycleCountValues(CYCCNTData);
        })

        // Function to update the 'CYCCNT' line chart
        function filterUpdateCYCCNTCharts(data) {
            const cyccntLabels = Array.from({ length: data.length }, (_, i) => i + 1); // Sequential x-axis values
            CYCCNTData = data.filter(row => ['CYCCNT1', 'CYCCNT2', 'CYCCNT3'].some(v => row.NodeId.includes(v)));
            const cyccntDatasets = createDatasets(CYCCNTData, ['X', 'Y', 'Z']);
            // Create line chart with datasets for 'CYCCNT'
            createLineChart(cycleCountsChartId, cyccntLabels, cyccntDatasets, 'CYCCNT');
        }

        function filterUpdateCycleCountCharts(data) {
            const cycleCountlabels = Array.from({ length: data.length }, (_, i) => i + 1); // Sequential x-axis values
            CycleCountData = data.filter(row => ['CycleCount1'].some(v => row.NodeId.includes(v)));
            const cycleCountDatasets = createDatasets(CycleCountData, ['Spindle']);
            // Create line chart with datasets for 'CycleCount'
            createLineChart(cycleCountsSpindleChartId, cycleCountlabels, cycleCountDatasets, 'CycleCount');
        }

        function aeiou(motor)  {
            /*
            if (motor == 'Spindle')
                toggleMotorSelection(motor, CycleCountData);
            else
                toggleMotorSelection(motor, CYCCNTData);
            */
            const button = document.getElementById(`button${motor}`);
            button.classList.toggle("selected-button");
            
            toggleMotorSelection(cycleCountsChartId, CYCCNTData, 'CYCCNT');
            toggleMotorSelection(cycleCountsSpindleChartId, CycleCountData, 'CycleCount');
        }
        
    </script>
{% endblock%}