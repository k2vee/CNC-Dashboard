{% extends 'base.html' %}
{% block content %}
<div id="motorSelectionButtons">
    <button id="buttonX" class="motor-button" onclick="aeiou('X')">
        Motor X</button>
    <button id="buttonY" class="motor-button" onclick="aeiou('Y')">
        Motor Y</button>
    <button id="buttonZ" class="motor-button" onclick="aeiou('Z')">
        Motor Z</button>
    <button id="buttonSpindle" class="motor-button" onclick="aeiou('Spindle')">
        Spindle</button>
</div>
<div id="latestValues">
    <div class="chart-latestValues">
        <p class="valueTitle">Current</p>
        <p class="motorId">Motor X</p>
        <p id="latest-X">0</p>
        <p class="motorId">Motor Y</p>
        <p id="latest-Y">0</p>
        <p class="motorId">Motor Z</p>
        <p id="latest-Z">0</p>
    </div>
    <div class="chart-latestValues">
        <p class="valueTitle">Maximum Currents</p>
        <p class="motorId">Motor X</p>
        <p id="latest-X">0</p>
        <p class="motorId">Motor Y</p>
        <p id="latest-Y">0</p>
        <p class="motorId">Motor Z</p>
        <p id="latest-Z">0</p>
    </div>
</div>
<div id="currentGraphs" class="graph-container">
    <div class="chart-wrapper">
        <canvas id="currentChart"></canvas>
    </div>
    <div class="chart-wrapper">
        <canvas id="maxCurChart"></canvas>
    </div>
</div>
<button id="updateButton" style="background-color: aqua; color: black;"> update button </button>
<button id="removeButton" style="background-color:darkviolet; color: black;"> remove button </button>
{% endblock %}
{% block script %}
<script>
    // Global vars/accessible data objects
    var CurrentData, MAXCURData;
    var timerId;
    const currentCanvasId = 'currentChart';
    const maxCurCanvasId = 'maxCurChart';

    // Event listeners
    document.getElementById("removeButton").addEventListener("click", () => removeLineChartData(currentCanvasId));
    document.addEventListener('DOMContentLoaded', async () => {
        CurrentData = await fetchDataGroupLimited('Current', 50);
        CurrentData.reverse();
        filterUpdateCurrentChart(CurrentData);

        MAXCURData = await fetchDataGroupLimited('MAXCUR', 50);
        MAXCURData.reverse();
        filterUpdateMaxcurChart(MAXCURData);

        updateCurrentValues(CurrentData);
        timerId = setInterval(pollServer, 3000);
    });

    // Function to update the 'Current' line chart
    function filterUpdateCurrentChart(data) {
        const currentLabels = Array.from({ length: data.length }, (_, i) => i + 1); // Sequential x-axis values
        CurrentData = data.filter(row => ['Current1', 'Current2', 'Current3'].some(v => row.NodeId.includes(v)));
        const currentDatasets = createDatasets(CurrentData, ['X', 'Y', 'Z']);
        // Create line chart with datasets for 'Current'
        createLineChart(currentCanvasId, currentLabels, currentDatasets, 'Current');
    }

    // Function to update the 'Current' line chart
    function filterUpdateMaxcurChart(data) {
        const maxCurlabels = Array.from({ length: data.length }, (_, i) => i + 1); // Sequential x-axis values
        MAXCURData = data.filter(row => ['MAXCUR21', 'MAXCUR22', 'MAXCUR23'].some(v => row.NodeId.includes(v)));
        const maxCurDatasets = createDatasets(MAXCURData, ['X', 'Y', 'Z']);
        // Create line chart with datasets for 'MAXCUR'
        createLineChart(maxCurCanvasId, maxCurlabels, maxCurDatasets, 'MAXCUR');
    }

    function aeiou(motor) {
        /*
        if (motor == 'Spindle')
            toggleMotorSelection(motor, CurrentData);
        else
            toggleMotorSelection(motor, MAXCURData);
        */
        const button = document.getElementById(`button${motor}`);
        button.classList.toggle("selected-button");

        datasetFilter()
        //toggleMotorSelection(currentCanvasId, CurrentData, 'Current');
        //toggleMotorSelection(maxCurCanvasId, MAXCURData, 'MAXCUR');
    }

    async function pollServer() {
        const alphabetArray = ['X', 'Y', 'Z'];
        for(var i = 0; i < 3; i++)  {
            const latestRecord = await fetchDataSingular(`Current${i+1}`);
            CurrentData.shift();
            CurrentData.push(latestRecord);
            shiftLineChartData(currentCanvasId, `Motor ${alphabetArray[i]}`, latestRecord);
        }
        for(var i = 0; i < 3; i++)  {
            const latestRecord = await fetchDataSingular(`MAXCUR2${i+1}`);
            MAXCURData.shift();
            MAXCURData.push(latestRecord);
            shiftLineChartData(maxCurCanvasId, `Motor ${alphabetArray[i]}`, latestRecord);
        }
    }
</script>
{% endblock%}